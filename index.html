<!DOCTYPE html>
        <html lang="en">
        <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>ScrollEd - Home</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <!-- PDF.js Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
        <script>
                // Required for PDF.js to work
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        </script>
        <style>
                html, body {
                font-family: 'Inter', sans-serif;
                overscroll-behavior: contain; /* Prevents background scroll on mobile */
                overflow-x: hidden; /* Disables horizontal scrolling */
                }
                body.home-background {
                background-image: linear-gradient(rgba(17, 24, 39, 0.95), rgba(17, 24, 39, 0.95)), url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=1887&auto=format&fit=crop');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                }
                /* Hide scrollbar for Chrome, Safari and Opera */
                ::-webkit-scrollbar {
                display: none;
                }

                /* Hide scrollbar for IE, Edge and Firefox */
                body, #home-view, #review-content-wrapper, #history-list, #quiz-active-view, #quiz-results-view, #leaderboard-list, #profile-friends-list, #quiz-breakdown-view {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
                }
                .spinner {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 4px solid #3b82f6;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

                /* --- Flashcard Styles --- */
                #flashcard-container {
                position: relative;
                width: 100%;
                height: 400px; /* Fixed height for the card area */
                perspective: 1000px;
                }
                .flashcard {
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: #374151; /* bg-gray-700 */
                border-radius: 1.5rem; /* rounded-3xl */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 1.5rem;
                text-align: center;
                user-select: none;
                touch-action: none; /* Important for pointer events */
                transition: transform 0.3s ease, opacity 0.3s ease;
                box-shadow: 0 10px 20px rgba(0,0,0,0.2);
                border: 1px solid #4b5563;
                pointer-events: none; /* Make cards non-interactive by default */
                }
                .flashcard.top-card {
                pointer-events: auto; /* Make ONLY the top card interactive */
                cursor: grab;
                }
                .flashcard.dragging {
                cursor: grabbing;
                transition: none; /* No transition while actively dragging */
                }
                .flashcard h3 {
                font-size: 1.5rem; /* Default font size */
                font-weight: bold;
                color: #d1d5db; /* text-gray-300 */
                }
               
                /* --- Quiz Reel Styles --- */
                #quiz-active-view-wrapper {
                display: flex;
                flex-direction: column;
                flex: 1;
                overflow: hidden;
                }
                #quiz-active-view {
                scroll-snap-type: y mandatory;
                flex: 1;
                overflow-y: auto;
                min-height: 0; /* FIX: Prevents flex item from overflowing its container */
                }
                .quiz-question-slide {
                scroll-snap-align: center;
                display: flex;
                align-items: top;
                justify-content: center;
                flex-shrink: 0;
                width: 100%;
                height: 100%; /* Each slide takes full height of the container */
                padding: 1rem;
                }
                .quiz-question-card {
                width: 100%;
                max-width: 95%;
                padding: 1.5rem;
                background-color: #1f2937;
                border-radius: 1.5rem;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                }

                .quiz-option.selected-option {
                background-color: #3b82f6; /* bg-blue-600 */
                border-color: #60a5fa; /* border-blue-400 */
                }
                .time-btn.selected {
                background-color: #3b82f6; /* bg-blue-600 */
                font-weight: bold;
                }


                /* --- Custom Toggle Switch --- */
                .toggle-switch {
                position: relative;
                display: inline-block;
                width: 120px;
                height: 34px;
                }
                .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
                }
                .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #374151; /* bg-gray-700 */
                transition: .4s;
                border-radius: 34px;
                }
                .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 55px;
                left: 4px;
                bottom: 4px;
                background-color: #3b82f6; /* bg-blue-600 */
                transition: .4s;
                border-radius: 34px;
                z-index: 1;
                }
                input:checked + .slider {
                background-color: #374151;
                }
                input:checked + .slider:before {
                transform: translateX(55px);
                }
                .slider-text {
                position: absolute;
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: space-around;
                align-items: center;
                font-size: 12px;
                font-weight: bold;
                color: white;
                z-index: 0;
                pointer-events: none;
                }
                .slider-text .icon {
                width: 18px;
                height: 18px;
                stroke-width: 2;
                transition: color 0.4s ease;
                color: #9ca3af; /* gray-400 */
                }
                .slider-text .icon.active {
                color: white;
                }

                /* --- Profile Tabs --- */
                .profile-tab.active {
                border-color: #3b82f6;
                color: #60a5fa;
                }

                /* Ensure content doesn't hide behind the fixed navbar */
                #home-view, #review-view, #history-view, #quiz-view, #flashcard-view, #app-wrapper, #leaderboard-view, #profile-view, #quiz-breakdown-view {
                padding-bottom: 4.5rem; /* 72px */
                }
        </style>
        </head>
        <body class="bg-gray-900 text-white min-h-screen">

        <!-- App Container -->
        <div class="w-full max-w-xl mx-auto flex flex-col h-screen">
               
                <!-- View 0: Loading View -->
                <div id="loading-view" class="flex flex-col justify-center items-center flex-1 p-4">
                <div class="spinner"></div>
                <p id="loading-text" class="mt-4 text-gray-400">Initializing...</p>
                </div>

                <div id="app-wrapper" class="hidden h-full flex flex-col p-4">
                <!-- View 1: Home Page -->
                <div id="home-view" class="hidden flex-col flex-1 overflow-y-auto">
                        <header class="relative mb-6 text-center pt-4">
                        <h1 class="text-5xl md:text-6xl font-extrabold" style="background: linear-gradient(to right, #3b82f6, #16a34a); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">ScrollEd</h1>
                        <div class="absolute top-2 right-0 flex items-center space-x-2">
                                <!-- Streak Counter -->
                                <div id="streak-container" class="w-20 h-20 bg-gray-800 border border-gray-700 rounded-full flex flex-col items-center justify-center text-center p-1">
                                <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z"></path></svg>
                                <p class="font-bold text-lg leading-tight"><span id="streak-count">0</span></p>
                                <p class="text-xs text-gray-400 leading-tight -mt-1">Days</p>
                                </div>
                        </div>
                        </header>
                        <main class="space-y-6 mt-10">
                        <div class="bg-gray-800/80 backdrop-blur-sm border border-gray-700 rounded-2xl p-6">
                                <form id="topic-form">
                                <label for="topic-input" class="text-2xl font-bold text-gray-100 block text-center mb-4">Enter a Topic</label>
                                <input type="text" id="topic-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Topic Name" required>
                                <div id="topic-card-count-wrapper" class="hidden mt-4">
                                        <label for="card-count-input" class="text-sm font-medium text-gray-300 block text-left mb-2">Number of Cards:</label>
                                        <input type="number" id="card-count-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" value="5" min="5" max="30" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition duration-300 h-12">Generate Notes</button>
                                </form>
                        </div>
                        <div class="text-white font-semibold text-center py-1 px-3 rounded-full bg-gray-800/50 backdrop-blur-sm self-center w-min mx-auto">OR</div>
                        <div id="upload-section" class="bg-gray-800/80 backdrop-blur-sm border border-gray-700 rounded-2xl p-6 text-center">
                                <label for="file-upload" class="cursor-pointer">
                                <h2 class="text-2xl font-bold text-gray-100">Upload Document</h2>
                                <p class="text-gray-400 mt-1">Learn from your PDF files.</p>
                                <input id="file-upload" type="file" class="hidden" accept=".pdf">
                                </label>
                                <div id="upload-card-count-wrapper" class="hidden mt-4">
                                <label for="card-count-upload-input" class="text-sm font-medium text-gray-300 block text-left mb-2">Number of Cards:</label>
                                <input type="number" id="card-count-upload-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" value="5" min="5" max="30" required>
                                <button id="upload-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition duration-300 h-12">Generate from PDF</button>
                                </div>
                                <div id="upload-spinner" class="hidden spinner mx-auto mt-4" style="width: 24px; height: 24px; border-width: 2px;"></div>
                        </div>
                        </main>
                </div>

                <!-- View 2: Flashcard View (Initially Hidden) -->
                <div id="flashcard-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 id="flashcard-topic-title" class="text-xl font-bold text-blue-400 text-right truncate"></h2>
                        </header>
                        <main id="flashcard-content" class="flex-1 flex flex-col justify-center items-center">
                        <!-- Loading or cards go here -->
                        </main>
                </div>
               
                <!-- View 3: Review View (Initially Hidden) -->
                <div id="review-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="review-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 class="text-2xl font-bold text-green-400">Review Session</h2>
                        </header>
                        <main id="review-content-wrapper" class="flex-1 bg-gray-800 border border-gray-700 rounded-2xl p-6 overflow-y-auto">
                        <div id="review-content" class="space-y-6"></div>
                        <div id="continue-learning-prompt" class="mt-8 pt-6 border-t border-gray-700 text-center"></div>
                        </main>
                </div>

                <!-- View 4: History View (Initially Hidden) -->
                <div id="history-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="history-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 class="text-2xl font-bold text-green-400">Learning History</h2>
                        </header>
                        <main id="history-list" class="flex-1 bg-gray-800 border border-gray-700 rounded-2xl p-2 space-y-2 overflow-y-auto">
                        <!-- History items will be injected here -->
                        </main>
                </div>

                <!-- View 5: Quiz View (Initially Hidden) -->
                <div id="quiz-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="quiz-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 class="text-2xl font-bold text-purple-400">Quiz Time!</h2>
                        </header>
                        <main id="quiz-container" class="flex-1 flex flex-col bg-gray-800 border border-gray-700 rounded-2xl overflow-hidden">
                       
                        <!-- New Quiz Start View -->
                        <div id="quiz-start-view" class="p-6 space-y-6 overflow-y-auto">
                                <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                                <form id="quiz-topic-form">
                                        <label for="quiz-topic-input" class="text-2xl font-bold text-gray-100 block text-center mb-4">Enter a Topic</label>
                                        <input type="text" id="quiz-topic-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'The Roman Empire'" required>
                                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition duration-300 h-12">Create Quiz Room</button>
                                </form>
                                </div>
                                <div class="text-gray-500 font-semibold text-center">OR</div>
                                <div id="quiz-upload-section" class="bg-gray-800 border border-gray-700 rounded-2xl p-6 text-center">
                                <label for="quiz-file-upload" class="cursor-pointer">
                                        <h2 class="text-2xl font-bold text-gray-100">Upload Document</h2>
                                        <p class="text-gray-400 mt-1">Generate a quiz from your PDF files.</p>
                                        <input id="quiz-file-upload" type="file" class="hidden" accept=".pdf">
                                </label>
                                <div id="quiz-upload-feedback" class="mt-4"></div>
                                </div>
                                <div class="text-gray-500 font-semibold text-center">OR</div>
                                <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6">
                                <form id="join-room-form">
                                        <label for="room-code-input" class="text-2xl font-bold text-gray-100 block text-center mb-4">Join a Room</label>
                                        <input type="text" id="room-code-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter Room Code" required>
                                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition duration-300 h-12">Join Quiz</button>
                                </form>
                                </div>
                        </div>
                       
                        <div id="quiz-content-wrapper" class="flex-1 flex flex-col hidden">
                                <!-- State 1: Quiz Configuration -->
                                <div id="quiz-config-view" class="p-6 flex flex-col flex-1">
                                <div class="mb-8 text-center">
                                        <h3 class="text-2xl font-bold text-gray-100">Set Up Your Quiz</h3>
                                        <p class="text-gray-400 mt-2">
                                        Select your quiz format. Choose '#' for a quiz with a set number of questions, or '🕒' for a timed challenge.
                                        </p>
                                </div>
                                <div class="space-y-6 flex-1">
                                        <div class="flex justify-between items-center">
                                        <span class="font-semibold text-lg">Quiz Mode</span>
                                        <label class="toggle-switch">
                                                <input type="checkbox" id="quiz-mode-toggle">
                                                <span class="slider"></span>
                                                <div class="slider-text">
                                                <svg id="toggle-icon-number" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                                                <svg id="toggle-icon-time" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                </div>
                                        </label>
                                        </div>
                                       
                                        <!-- Number Mode Options -->
                                        <div id="quiz-number-mode">
                                        <label for="quiz-question-count" class="block mb-2 font-medium">Number of Questions:</label>
                                        <input type="number" id="quiz-question-count" value="5" min="3" max="20" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                                        </div>

                                        <!-- Time Mode Options -->
                                        <div id="quiz-time-mode" class="hidden">
                                        <label class="block mb-2 font-medium">Quiz Duration:</label>
                                        <div class="grid grid-cols-3 gap-2">
                                                <button class="time-btn p-2 bg-gray-700 rounded-lg" data-time="5">5 min</button>
                                                <button class="time-btn p-2 bg-gray-700 rounded-lg" data-time="10">10 min</button>
                                                <button class="time-btn p-2 bg-gray-700 rounded-lg" data-time="15">15 min</button>
                                                <button class="time-btn p-2 bg-gray-700 rounded-lg" data-time="30">30 min</button>
                                                <button class="time-btn p-2 bg-gray-700 rounded-lg" data-time="60">1 hr</button>
                                        </div>
                                        </div>
                                </div>
                                <button id="begin-quiz-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition mt-auto" style="margin-top: 15px;">Begin Quiz</button>
                                </div>

                                <!-- State 2: Active Quiz -->
                                <div id="quiz-active-view-wrapper" class="hidden">
                                <div id="quiz-header" class="flex justify-between items-center p-2 bg-gray-700/50">
                                        <div id="quiz-timer" class="font-bold text-lg"></div>
                                        <div id="quiz-room-code" class="font-bold text-lg"></div>
                                </div>
                                <div id="quiz-active-view">
                                        <!-- Questions will be rendered here -->
                                </div>
                                </div>
                        </div>
                        <p id="quiz-placeholder" class="hidden text-center text-gray-400 p-4 m-auto">Start a lesson or visit your history to generate a quiz.</p>
                        </main>
                </div>

                <!-- View 6: Leaderboard View -->
                <div id="leaderboard-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="leaderboard-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 class="text-2xl font-bold text-yellow-400">Leaderboard</h2>
                        </header>
                        <div class="mb-4">
                        <input type="text" id="leaderboard-search" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400" placeholder="Search for users...">
                        </div>
                        <main id="leaderboard-list" class="flex-1 bg-gray-800 border border-gray-700 rounded-2xl p-2 space-y-2 overflow-y-auto">
                        <!-- Leaderboard items will be injected here -->
                        </main>
                </div>

                <!-- View 7: Profile View -->
                <div id="profile-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="profile-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 id="profile-header-title" class="text-2xl font-bold text-blue-400">Profile</h2>
                        </header>
                        <main class="flex-1 bg-gray-800 border border-gray-700 rounded-2xl p-6 space-y-6 overflow-y-auto">
                        <!-- User Info & Edit Section -->
                        <div>
                                <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center">
                                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <div class="flex-1">
                                        <div class="relative">
                                        <input type="text" id="new-name-input" class="w-full bg-transparent border-none p-0 text-2xl font-bold text-white" required minlength="3" maxlength="15" disabled>
                                        <button id="edit-name-btn" class="absolute top-1/2 right-0 -translate-y-1/2 text-gray-400 hover:text-white">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                        </button>
                                        </div>
                                        <div class="flex items-center gap-2 text-orange-400">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z"></path></svg>
                                        <span id="profile-streak-count" class="font-bold text-lg">0</span>
                                        </div>
                                </div>
                                </div>
                                <button id="save-name-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition hidden">Save Changes</button>
                                <p id="save-name-feedback" class="text-green-400 text-center mt-2 h-4"></p>
                        </div>

                        <!-- Badges Section -->
                        <div id="profile-badges-section" class="border-t border-gray-700 pt-6">
                                <h4 class="font-bold mb-2">Badges</h4>
                                <div id="profile-badges-container" class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                                <!-- Badges will be injected here -->
                                </div>
                        </div>
                        </main>
                </div>
               
                <!-- View 8: Quiz Breakdown View -->
                <div id="quiz-breakdown-view" class="hidden flex-1 flex-col">
                        <header class="flex items-center justify-between mb-4">
                        <button id="breakdown-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">&larr; Home</button>
                        <h2 class="text-2xl font-bold text-purple-400">Quiz Results</h2>
                        </header>
                        <main id="quiz-breakdown-content" class="flex-1 bg-gray-800 border border-gray-700 rounded-2xl p-6 space-y-6 overflow-y-auto">
                        <!-- Breakdown content will be injected here -->
                        </main>
                </div>
                </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 hidden">
                <div class="max-w-xl mx-auto flex justify-around items-center h-16">
                <button id="nav-leaderboard-btn" class="nav-btn flex flex-col items-center justify-center w-1/5 h-full rounded-lg">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Leaderboard
                </button>
                <button id="nav-history-btn" class="nav-btn flex flex-col items-center justify-center w-1/5 h-full rounded-lg">
                        <svg class="h-6 w-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        History
                </button>
                <button id="nav-home-btn" class="nav-btn flex flex-col items-center justify-center w-1/5 h-full rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg>
                        Home
                </button>
                <button id="nav-quiz-btn" class="nav-btn flex flex-col items-center justify-center w-1/5 h-full rounded-lg">
                        <svg class="h-6 w-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Quiz
                </button>
                <button id="nav-profile-btn" class="nav-btn flex flex-col items-center justify-center w-1/5 h-full rounded-lg">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Profile
                </button>
                </div>
        </nav>


        <!-- Firebase SDKs -->
        <script type="module">
                import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
                import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
                import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp, doc, getDoc, updateDoc, deleteDoc, setDoc, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

                // --- App Initialization ---
                const firebaseConfig = {
                apiKey: "AIzaSyBbfry__iW5suHA3Um7DcP_ebENvQQFiqw",
                authDomain: "scrolled-a6285.firebaseapp.com",
                projectId: "scrolled-a6285",
                storageBucket: "scrolled-a6285.appspot.com",
                messagingSenderId: "530253815612",
                appId: "1:530253815612:web:6d4fc95e97aee1d703c839",
                measurementId: "G-HRCVCFMM4R"
                };
                const appId = 'scrolled-a6285';
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // --- Global State ---
                let userId = null;
                let currentSessionId = null;
                let currentTopic = '';
                let currentTopicShort = '';
                let currentCardCount = 5;
                let currentDocumentText = '';
                let selectedFile = null;
                let flashcards = [];
                let allSeenPoints = [];
                let reviewItems = [];
                let understoodItems = [];
                let currentCardIndex = 0;
                let learningLevel = 1;
                let quizData = [];
                let userQuizAnswers = {};
                let quizPoints = []; // To store points for the current quiz
                let quizTimerInterval = null;
                let isDragging = false;
                let startX = 0;
                let offsetX = 0;
                let isAppInitialized = false;
                let allUsers = []; // Cache for leaderboard users
               
                // --- View Elements ---
                const loadingView = document.getElementById('loading-view');
                const appWrapper = document.getElementById('app-wrapper');
                const homeView = document.getElementById('home-view');
                const flashcardView = document.getElementById('flashcard-view');
                const reviewView = document.getElementById('review-view');
                const historyView = document.getElementById('history-view');
                const quizView = document.getElementById('quiz-view');
                const leaderboardView = document.getElementById('leaderboard-view');
                const profileView = document.getElementById('profile-view');
                const quizBreakdownView = document.getElementById('quiz-breakdown-view');
                const bottomNav = document.getElementById('bottom-nav');
                const streakCountEl = document.getElementById('streak-count');
               
                // --- Form Elements ---
                const topicForm = document.getElementById('topic-form');
                const topicInput = document.getElementById('topic-input');
                const cardCountInput = document.getElementById('card-count-input');
                const topicCardCountWrapper = document.getElementById('topic-card-count-wrapper');
                const submitButton = topicForm.querySelector('button[type="submit"]');
                const fileUpload = document.getElementById('file-upload');
                const uploadSpinner = document.getElementById('upload-spinner');
                const uploadCardCountWrapper = document.getElementById('upload-card-count-wrapper');
                const cardCountUploadInput = document.getElementById('card-count-upload-input');
                const uploadSubmitBtn = document.getElementById('upload-submit-btn');

                // --- Flashcard View Elements ---
                const backBtn = document.getElementById('back-btn');
                const flashcardTopicTitle = document.getElementById('flashcard-topic-title');
                const flashcardContent = document.getElementById('flashcard-content');
               
                // --- Review View Elements ---
                const reviewBackBtn = document.getElementById('review-back-btn');
                const reviewContent = document.getElementById('review-content');
                const continueLearningPrompt = document.getElementById('continue-learning-prompt');

                // --- History View Elements ---
                const historyBackBtn = document.getElementById('history-back-btn');
                const historyList = document.getElementById('history-list');

                // --- Leaderboard View Elements ---
                const leaderboardBackBtn = document.getElementById('leaderboard-back-btn');
                const leaderboardList = document.getElementById('leaderboard-list');
                const leaderboardSearch = document.getElementById('leaderboard-search');

                // --- Profile View Elements ---
                const profileBackBtn = document.getElementById('profile-back-btn');
                const profileHeaderTitle = document.getElementById('profile-header-title');
                const profileDisplayName = document.getElementById('profile-display-name');
                const profileStreakCount = document.getElementById('profile-streak-count');
                const editNameSection = document.getElementById('edit-name-section');
                const newNameInput = document.getElementById('new-name-input');
                const editNameBtn = document.getElementById('edit-name-btn');
                const saveNameBtn = document.getElementById('save-name-btn');
                const saveNameFeedback = document.getElementById('save-name-feedback');
                const profileBadgesContainer = document.getElementById('profile-badges-container');

                // --- Quiz View Elements ---
                const quizBackBtn = document.getElementById('quiz-back-btn');
                const quizContainer = document.getElementById('quiz-container');
                const quizContentWrapper = document.getElementById('quiz-content-wrapper');
                const quizPlaceholder = document.getElementById('quiz-placeholder');
                const quizStartView = document.getElementById('quiz-start-view');
                const quizTopicForm = document.getElementById('quiz-topic-form');
                const quizFileUpload = document.getElementById('quiz-file-upload');
                const quizUploadFeedback = document.getElementById('quiz-upload-feedback');
                const quizConfigView = document.getElementById('quiz-config-view');
                const quizActiveViewWrapper = document.getElementById('quiz-active-view-wrapper');
                const quizTimerEl = document.getElementById('quiz-timer');
                const quizActiveView = document.getElementById('quiz-active-view');
                const quizBreakdownContent = document.getElementById('quiz-breakdown-content');
                const breakdownBackBtn = document.getElementById('breakdown-back-btn');
                const quizModeToggle = document.getElementById('quiz-mode-toggle');
                const quizNumberMode = document.getElementById('quiz-number-mode');
                const quizTimeMode = document.getElementById('quiz-time-mode');
                const beginQuizBtn = document.getElementById('begin-quiz-btn');
                const toggleIconNumber = document.getElementById('toggle-icon-number');
                const toggleIconTime = document.getElementById('toggle-icon-time');
                const joinRoomForm = document.getElementById('join-room-form');

                // --- Nav Elements ---
                const navHomeBtn = document.getElementById('nav-home-btn');
                const navHistoryBtn = document.getElementById('nav-history-btn');
                const navLeaderboardBtn = document.getElementById('nav-leaderboard-btn');
                const navQuizBtn = document.getElementById('nav-quiz-btn');
                const navProfileBtn = document.getElementById('nav-profile-btn');

                // --- Auth Logic ---
                onAuthStateChanged(auth, async (user) => {
                if (user && !isAppInitialized) {
                        isAppInitialized = true;
                        userId = user.uid;
                        await checkAndCreateUserProfile();
                        await checkAndUpdateStreak();
                        loadingView.classList.add('hidden');
                        appWrapper.classList.remove('hidden');
                        goHome();
                }
                });

                (async () => {
                try {
                        await signInAnonymously(auth);
                } catch (error) {
                        console.error("Authentication Error:", error);
                        loadingView.textContent = "Authentication Failed. Please refresh.";
                }
                })();

                // --- Event Listeners ---
                topicForm.addEventListener('submit', handleTopicSubmit);
                topicInput.addEventListener('input', () => {
                topicCardCountWrapper.classList.toggle('hidden', topicInput.value.trim() === '');
                });
                fileUpload.addEventListener('change', (e) => {
                selectedFile = e.target.files[0];
                uploadCardCountWrapper.classList.toggle('hidden', !selectedFile);
                });
                uploadSubmitBtn.addEventListener('click', handleFileSubmit);
                backBtn.addEventListener('click', goHome);
                reviewBackBtn.addEventListener('click', goHome);
                historyBackBtn.addEventListener('click', goHome);
                quizBackBtn.addEventListener('click', goHome);
                leaderboardBackBtn.addEventListener('click', goHome);
                profileBackBtn.addEventListener('click', goHome);
                breakdownBackBtn.addEventListener('click', goHome);
                editNameBtn.addEventListener('click', () => {
                newNameInput.disabled = false;
                newNameInput.focus();
                editNameBtn.classList.add('hidden');
                saveNameBtn.classList.remove('hidden');
                });
                saveNameBtn.addEventListener('click', handleSaveName);
                leaderboardSearch.addEventListener('input', handleSearch);
                navHomeBtn.addEventListener('click', goHome);
                navHistoryBtn.addEventListener('click', showHistoryScreen);
                navLeaderboardBtn.addEventListener('click', showLeaderboardScreen);
                navProfileBtn.addEventListener('click', () => showProfileScreen()); // Pass no ID for current user
                navQuizBtn.addEventListener('click', () => {
                showScreen(quizView);
                quizStartView.classList.remove('hidden');
                quizContentWrapper.classList.add('hidden');
                quizPlaceholder.classList.add('hidden');
                });
               
                toggleIconNumber.classList.add('active');
                quizModeToggle.addEventListener('change', () => {
                quizNumberMode.classList.toggle('hidden');
                quizTimeMode.classList.toggle('hidden');
                toggleIconNumber.classList.toggle('active');
                toggleIconTime.classList.toggle('active');
                });
                beginQuizBtn.addEventListener('click', handleBeginQuiz);
                quizTimeMode.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                        quizTimeMode.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                });
                });
                quizTopicForm.addEventListener('submit', handleQuizTopicSubmit);
                quizFileUpload.addEventListener('change', handleQuizFileSelect);
                joinRoomForm.addEventListener('submit', handleJoinRoom);


                // --- Navigation ---
                function updateNav(activeTab) {
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                        btn.classList.remove('text-blue-400', 'font-semibold', 'bg-gray-700');
                        btn.classList.add('text-gray-400');
                });

                const activeBtn = document.getElementById(`nav-${activeTab}-btn`);
                if (activeBtn) {
                        activeBtn.classList.add('text-blue-400', 'font-semibold', 'bg-gray-700');
                        activeBtn.classList.remove('text-gray-400');
                }
                }

                function showScreen(screen) {
                const allViews = [homeView, flashcardView, reviewView, historyView, quizView, leaderboardView, profileView, quizBreakdownView];
                allViews.forEach(view => view.style.display = 'none');
               
                document.body.classList.remove('home-background');
                bottomNav.classList.remove('hidden');
                screen.style.display = 'flex';

                if (screen === homeView) {
                        updateNav('home');
                        document.body.classList.add('home-background');
                }
                else if (screen === historyView) updateNav('history');
                else if (screen === leaderboardView) updateNav('leaderboard');
                else if (screen === quizView) updateNav('quiz');
                else if (screen === profileView) updateNav('profile');
                else updateNav('');
                }

                function goHome() {
                showScreen(homeView);
                resetState();
                }

                function resetState() {
                currentSessionId = null;
                currentTopic = '';
                currentTopicShort = '';
                currentDocumentText = '';
                selectedFile = null;
                flashcards = [];
                allSeenPoints = [];
                reviewItems = [];
                understoodItems = [];
                currentCardIndex = 0;
                learningLevel = 1;
                quizData = [];
                userQuizAnswers = {};
                quizPoints = [];
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                quizTimerInterval = null;
                topicInput.value = '';
                cardCountInput.value = '5';
                cardCountUploadInput.value = '5';
                submitButton.disabled = false;
                submitButton.innerHTML = 'Generate Notes';
                uploadSpinner.classList.add('hidden');
                uploadSubmitBtn.classList.remove('hidden');
                fileUpload.value = '';
                topicCardCountWrapper.classList.add('hidden');
                uploadCardCountWrapper.classList.add('hidden');
                }

                // --- Main Logic ---
                async function handleTopicSubmit(e) {
                e.preventDefault();
                const topic = topicInput.value.trim();
                const cardCount = parseInt(cardCountInput.value, 10);
                if (!topic) return;

                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="spinner mx-auto" style="width: 24px; height: 24px; border-width: 2px;"></div>`;
               
                resetState();
                currentTopic = topic;
                currentCardCount = cardCount;
                currentTopicShort = await shortenTopicName(topic);
                await generateNewCardSet();
                }

                async function handleFileSubmit() {
                if (!selectedFile) return;

                uploadSpinner.classList.remove('hidden');
                uploadSubmitBtn.classList.add('hidden');
               
                try {
                        const text = await extractTextFromPdf(selectedFile);
                        const cardCount = parseInt(cardCountUploadInput.value, 10);

                        resetState();
                        currentDocumentText = text;
                        currentCardCount = cardCount;

                        currentTopic = await getTopicFromDocument(text);
                        currentTopicShort = await shortenTopicName(currentTopic);

                        await generateNewCardSet();

                } catch (error) {
                        console.error("Error processing PDF:", error);
                        const uploadSection = document.getElementById('upload-section');
                        uploadSection.innerHTML += `<p class="text-red-400 mt-2">Could not process PDF.</p>`;
                        setTimeout(goHome, 3000);
                }
                }

                async function generateNewCardSet() {
                flashcardTopicTitle.textContent = currentTopicShort;
                showScreen(flashcardView);
                showLoading('flashcard');

                try {
                        const generatedCards = await fetchFlashcardsFromAI(currentTopic, currentCardCount, learningLevel, allSeenPoints, currentDocumentText);
                        flashcards = generatedCards;
                        generatedCards.forEach(card => allSeenPoints.push(card.point));
                        renderFlashcards();
                } catch (error) {
                        console.error("Error fetching flashcards:", error);
                        displayError('flashcard');
                }
                }

                // --- UI Rendering ---
                function showLoading(view) {
                const loadingHTML = `<div class="flex flex-col items-center justify-center p-8 h-full"><div class="spinner"></div><p class="mt-4 text-gray-400">Loading...</p></div>`;
                if (view === 'flashcard') flashcardContent.innerHTML = loadingHTML;
                if (view === 'review') reviewContent.innerHTML = loadingHTML;
                if (view === 'history') historyList.innerHTML = loadingHTML;
                if (view === 'leaderboard') leaderboardList.innerHTML = loadingHTML;
                if (view === 'quiz') {
                        quizStartView.innerHTML = loadingHTML;
                }
                }

                function displayError(view) {
                const errorHTML = `<div class="text-center p-8 h-full"><p class="text-red-400 font-semibold">Oops! Something went wrong.</p><p class="text-gray-400 mt-2">Could not load content.</p></div>`;
                if (view === 'flashcard') flashcardContent.innerHTML = errorHTML;
                if (view === 'history') historyList.innerHTML = errorHTML;
                if (view === 'leaderboard') leaderboardList.innerHTML = errorHTML;
                if (view === 'quiz') quizActiveView.innerHTML = errorHTML;
                }

                function renderFlashcards() {
                if (flashcards.length === 0) {
                        flashcardContent.innerHTML = '<p class="text-center">No new cards could be generated for this topic.</p>';
                        return;
                }
                currentCardIndex = 0;
                reviewItems = [];
                understoodItems = [];
               
                flashcardContent.innerHTML = `
                        <div id="flashcard-container"></div>
                        <div class="mt-4 text-xs text-gray-500 text-center">
                        Swipe Left (✕) to review, Swipe Right (✓) if you understand.
                        </div>
                        <div class="mt-2 text-gray-400" id="card-counter">1 / ${flashcards.length}</div>
                        <div class="flex justify-around w-full mt-4">
                        <button id="swipe-left-btn" class="p-4 bg-red-500/20 text-red-400 rounded-full text-2xl font-bold">✕</button>
                        <button id="swipe-right-btn" class="p-4 bg-green-500/20 text-green-400 rounded-full text-2xl font-bold">✓</button>
                        </div>`;
               
                const container = document.getElementById('flashcard-container');
                flashcards.forEach((card, index) => {
                        const cardEl = document.createElement('div');
                        cardEl.classList.add('flashcard');
                        if (index === 0) cardEl.classList.add('top-card');
                        cardEl.style.zIndex = flashcards.length - index;

                        const h3El = document.createElement('h3');
                        h3El.textContent = card.point;
                       
                        if (card.point.length > 220) h3El.style.fontSize = '1.0rem';
                        else if (card.point.length > 150) h3El.style.fontSize = '1.25rem';
                       
                        cardEl.appendChild(h3El);
                        container.appendChild(cardEl);
                });
               
                updateCardStackVisuals();
                attachSwipeListeners();
                document.getElementById('swipe-left-btn').onclick = () => handleSwipe('left');
                document.getElementById('swipe-right-btn').onclick = () => handleSwipe('right');
                }
               
                // --- Swipe Logic ---
                function attachSwipeListeners() {
                const topCard = document.querySelector('.top-card');
                if (!topCard) return;

                const onPointerMove = (e) => {
                        if (!isDragging) return;
                        e.preventDefault();
                        const currentX = e.clientX || e.touches[0].clientX;
                        offsetX = currentX - startX;
                        const rotation = offsetX * 0.1;
                        topCard.style.transform = `translateX(${offsetX}px) rotate(${rotation}deg)`;
                };

                const onPointerUp = () => {
                        document.removeEventListener('mousemove', onPointerMove);
                        document.removeEventListener('touchmove', onPointerMove);
                        document.removeEventListener('mouseup', onPointerUp);
                        document.removeEventListener('touchend', onPointerUp);

                        if (!isDragging) return;
                        isDragging = false;
                        topCard.classList.remove('dragging');
                       
                        const swipeThreshold = window.innerWidth * 0.3;
                        if (Math.abs(offsetX) > swipeThreshold) {
                        handleSwipe(offsetX > 0 ? 'right' : 'left');
                        } else {
                        topCard.style.transform = '';
                        }
                        offsetX = 0;
                };
               
                const onPointerDown = (e) => {
                        isDragging = true;
                        startX = e.clientX || e.touches[0].clientX;
                        topCard.classList.add('dragging');
                        document.addEventListener('mousemove', onPointerMove);
                        document.addEventListener('touchmove', onPointerMove, { passive: false });
                        document.addEventListener('mouseup', onPointerUp);
                        document.addEventListener('touchend', onPointerUp);
                };

                topCard.addEventListener('mousedown', onPointerDown);
                topCard.addEventListener('touchstart', onPointerDown, { passive: true });
                }

                function handleSwipe(direction) {
                if (currentCardIndex >= flashcards.length) return;
                const topCard = document.querySelector('.top-card');
                if (!topCard) return;
               
                topCard.classList.remove('top-card');
               
                const flyOutX = (direction === 'left' ? -1 : 1) * window.innerWidth;
                topCard.style.transform = `translateX(${flyOutX}px) rotate(${flyOutX / 20}deg)`;
                topCard.classList.add('swiped');
               
                const swipedItem = flashcards[currentCardIndex];
                if (direction === 'left') reviewItems.push(swipedItem);
                else understoodItems.push(swipedItem);
               
                currentCardIndex++;
               
                const newTopCard = document.querySelector('.flashcard:not(.swiped)');
                if(newTopCard) newTopCard.classList.add('top-card');
               
                updateCardStackVisuals();

                if (currentCardIndex >= flashcards.length) {
                        setTimeout(showReviewScreen, 500);
                } else {
                        document.getElementById('card-counter').textContent = `${currentCardIndex + 1} / ${flashcards.length}`;
                        attachSwipeListeners();
                }
                }

                function updateCardStackVisuals() {
                const cards = document.querySelectorAll('.flashcard:not(.swiped)');
                cards.forEach((card, index) => {
                        card.style.zIndex = cards.length - index;
                        card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                        if (index === 0) {
                        card.style.transform = 'translateY(0) scale(1)';
                        card.style.opacity = '1';
                        } else if (index === 1) {
                        card.style.transform = `translateY(10px) scale(0.95)`;
                        card.style.opacity = '1';
                        } else if (index === 2) {
                        card.style.transform = `translateY(20px) scale(0.9)`;
                        card.style.opacity = '1';
                        } else {
                        card.style.transform = `translateY(30px) scale(0.85)`;
                        card.style.opacity = '0';
                        }
                });
                }
               
                // --- Review Screen Logic ---
                async function showReviewScreen(isFromHistory = false, historyData = null) {
                showScreen(reviewView);
                continueLearningPrompt.innerHTML = '';

                const itemsToReview = isFromHistory ? historyData.reviewItems : reviewItems;
               
                if (itemsToReview.length === 0) {
                        reviewContent.innerHTML = `<div class="text-center p-8"><h3 class="text-2xl font-bold text-green-400">Great job!</h3><p class="text-gray-300 mt-2">You didn't mark any items for review.</p></div>`;
                } else {
                        showLoading('review');
                        try {
                        const summaryData = await fetchReviewSummaryFromAI(itemsToReview);
                        let reviewHTML = '';
                        summaryData.forEach((item) => {
                                reviewHTML += `
                                <div>
                                        <h3 class="text-lg font-bold text-blue-300 mb-2">${item.point}</h3>
                                        <p class="text-gray-400">${item.explanation}</p>
                                </div>
                                `;
                        });
                        reviewContent.innerHTML = reviewHTML;

                        } catch(error) {
                        console.error("Error fetching review:", error);
                        reviewContent.innerHTML = '<p class="text-red-400">Could not generate review summary.</p>';
                        }
                }

                if (!isFromHistory) {
                        currentSessionId = await saveSessionToHistory();
                        await markDayAsCompleted(); // Update streak on session completion
                }
               
                const sessionData = isFromHistory ? historyData : { id: currentSessionId, topic: currentTopic, topicShort: currentTopicShort, documentText: currentDocumentText, allSeenPoints: allSeenPoints };

                continueLearningPrompt.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-100">What's next?</h3>
                        <div class="space-y-3 mt-4">
                        <button id="attempt-quiz-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">Attempt Quiz</button>
                        <button id="continue-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Continue Learning</button>
                        <button id="finish-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition">Finish Session</button>
                        </div>
                `;
                document.getElementById('continue-btn').onclick = () => {
                        learningLevel++;
                        currentSessionId = sessionData.id;
                        currentTopic = sessionData.topic;
                        currentTopicShort = sessionData.topicShort;
                        currentDocumentText = sessionData.documentText || '';
                        allSeenPoints = sessionData.allSeenPoints;
                        generateNewCardSet();
                };
                document.getElementById('finish-btn').onclick = goHome;
                document.getElementById('attempt-quiz-btn').onclick = () => showQuizConfigScreen(sessionData.allSeenPoints);
                }

                // --- History Logic ---
                async function showHistoryScreen() {
                showScreen(historyView);
                showLoading('history');

                try {
                        const historyCollectionPath = `artifacts/${appId}/users/${userId}/sessions`;
                        const q = query(collection(db, historyCollectionPath));
                        const querySnapshot = await getDocs(q);
                        const sessions = [];
                        querySnapshot.forEach((doc) => {
                        sessions.push({ id: doc.id, ...doc.data() });
                        });

                        sessions.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                        if (sessions.length === 0) {
                        historyList.innerHTML = `<p class="text-center text-gray-400 p-4">No history yet. Complete a session to see it here!</p>`;
                        return;
                        }

                        historyList.innerHTML = sessions.map(session => `
                        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
                                <button class="history-delete-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center text-xs" data-session-id="${session.id}">X</button>
                                <div class="flex-1 flex justify-between items-center">
                                <div>
                                        <h3 class="font-bold text-white">${session.topicShort}</h3>
                                        <p class="text-sm text-gray-400">${session.reviewItems.length} items to review</p>
                                </div>
                                <div class="flex gap-2">
                                        <button class="history-review-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm" data-session-id="${session.id}">Review</button>
                                        <button class="history-quiz-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm" data-session-id="${session.id}">Quiz</button>
                                </div>
                                </div>
                        </div>
                        `).join('');

                        historyList.querySelectorAll('.history-review-btn').forEach(el => {
                        el.addEventListener('click', (e) => {
                                const sessionId = e.currentTarget.dataset.sessionId;
                                const sessionData = sessions.find(s => s.id === sessionId);
                                showReviewScreen(true, sessionData);
                        });
                        });
                        historyList.querySelectorAll('.history-quiz-btn').forEach(el => {
                        el.addEventListener('click', (e) => {
                                const sessionId = e.currentTarget.dataset.sessionId;
                                const sessionData = sessions.find(s => s.id === sessionId);
                                showQuizConfigScreen(sessionData.allSeenPoints);
                        });
                        });

                        historyList.querySelectorAll('.history-delete-btn').forEach(el => {
                        el.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevents other buttons from being clicked
                                const sessionId = e.currentTarget.dataset.sessionId;
                                handleDeleteSession(sessionId, e.currentTarget.closest('.bg-gray-700'));
                        });
                        });

                } catch (error) {
                        console.error("Error fetching history:", error);
                        displayError('history');
                }
                }

                async function saveSessionToHistory() {
                if (!userId) return;
                const historyCollectionPath = `artifacts/${appId}/users/${userId}/sessions`;
                try {
                        if (currentSessionId) {
                        const sessionRef = doc(db, historyCollectionPath, currentSessionId);
                        const docSnap = await getDoc(sessionRef);
                        if (docSnap.exists()) {
                                const existingData = docSnap.data();
                                const combinedReviewItems = [...existingData.reviewItems, ...reviewItems];
                                const updatedData = {
                                reviewItems: combinedReviewItems,
                                allSeenPoints: allSeenPoints,
                                timestamp: serverTimestamp()
                                };
                                await updateDoc(sessionRef, updatedData);
                                return currentSessionId;
                        }
                        } else {
                        const sessionData = {
                                topic: currentTopic,
                                topicShort: currentTopicShort,
                                reviewItems: reviewItems,
                                allSeenPoints: allSeenPoints,
                                documentText: currentDocumentText,
                                timestamp: serverTimestamp()
                        };
                        const docRef = await addDoc(collection(db, historyCollectionPath), sessionData);
                        return docRef.id;
                        }
                } catch (error) {
                        console.error("Error saving session:", error);
                }
                }

                // --- MODAL REPLACEMENT for confirm() ---
                function showCustomConfirm(message, callback) {
                const modalHTML = `
                        <div id="custom-confirm-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                        <div class="bg-gray-800 rounded-lg p-6 w-11/12 max-w-sm text-center">
                                <p class="mb-4">${message}</p>
                                <div class="flex justify-center gap-4">
                                <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
                                <button id="confirm-no" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">No</button>
                                </div>
                        </div>
                        </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const overlay = document.getElementById('custom-confirm-overlay');
                document.getElementById('confirm-yes').onclick = () => {
                        callback(true);
                        overlay.remove();
                };
                document.getElementById('confirm-no').onclick = () => {
                        callback(false);
                        overlay.remove();
                };
                }
               
                async function handleDeleteSession(sessionId, element) {
                showCustomConfirm("Are you sure you want to delete this session? This action cannot be undone.", async (confirmed) => {
                        if (!confirmed) return;

                        const historyCollectionPath = `artifacts/${appId}/users/${userId}/sessions`;
                        const sessionRef = doc(db, historyCollectionPath, sessionId);

                        try {
                        await deleteDoc(sessionRef);
                        element.remove();
                        if (historyList.children.length === 0) {
                                historyList.innerHTML = `<p class="text-center text-gray-400 p-4">No history yet. Complete a session to see it here!</p>`;
                        }
                        } catch (error) {
                        console.error("Error deleting session:", error);
                        }
                });
                }

                // --- User Profile & Streak Logic ---
                const BADGES = {
                streak1: { name: '1 Day Streak', streak: 1, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M4 17v4M2 19h4M17 3v4M16 5h4M18 17v4M17 19h4M12 5v14m-4-7h8"></path></svg>' },
                streak5: { name: '5 Day Streak', streak: 5, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.135 3.135 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.135 3.135 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.135-3.135 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.135-3.135z"></path></svg>' },
                streak10: { name: '10 Day Streak', streak: 10, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2.01V5M12 20v-1m0 1v.01M12 18v-1m0-1v-1m-4-2.01V13M8 11V9m4 11.01V17M16 15v-2m0-2v-2"></path></svg>' },
                streak30: { name: '1 Month Streak', streak: 30, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>' },
                streak90: { name: '3 Month Streak', streak: 90, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>' },
                streak180: { name: '6 Month Streak', streak: 180, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' },
                streak365: { name: '1 Year Streak', streak: 365, svg: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M4 17v4M2 19h4M17 3v4M16 5h4M18 17v4M17 19h4M12 5v14m-4-7h8"></path></svg>' },
                };

                function showDisplayNameModal() {
                const modalHTML = `
                        <div id="name-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center">
                                <h2 class="text-2xl font-bold mb-4">Welcome to ScrollEd!</h2>
                                <p class="text-gray-400 mb-6">Choose a display name.</p>
                                <form id="name-form">
                                <input type="text" id="name-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400" required minlength="3" maxlength="15">
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition">Save Name</button>
                                </form>
                        </div>
                        </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                document.getElementById('name-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const input = document.getElementById('name-input');
                        const displayName = input.value.trim();
                        if (displayName) {
                        const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                        await setDoc(publicProfileRef, { displayName: displayName, userId: userId, streak: 0, badges: [] }, { merge: true });
                        document.getElementById('name-modal-overlay').remove();
                        }
                });
                }

                async function checkAndCreateUserProfile() {
                if (!userId) return;
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                const docSnap = await getDoc(publicProfileRef);
                if (!docSnap.exists() || !docSnap.data().displayName) {
                        showDisplayNameModal();
                }
                }

                async function showProfileScreen() {
                showScreen(profileView);

                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                const docSnap = await getDoc(publicProfileRef);

                if (docSnap.exists()) {
                        const userData = docSnap.data();
                        newNameInput.value = userData.displayName || 'User';
                        profileStreakCount.textContent = userData.streak || 0;
                        renderBadges(userData.badges || []);
                }

                // Reset edit state
                saveNameFeedback.textContent = '';
                newNameInput.disabled = true;
                saveNameBtn.classList.add('hidden');
                editNameBtn.classList.remove('hidden');
                }

                function renderBadges(badgeIds) {
                if (badgeIds.length === 0) {
                        profileBadgesContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No badges yet.</p>';
                        return;
                }
                profileBadgesContainer.innerHTML = badgeIds.map(id => {
                        const badge = BADGES[id];
                        if (!badge) return '';
                        return `
                        <div class="flex flex-col items-center text-center p-2 bg-gray-700/50 rounded-lg">
                                <div class="w-12 h-12 flex items-center justify-center text-yellow-400">${badge.svg}</div>
                                <p class="text-xs mt-1 font-semibold">${badge.name}</p>
                        </div>
                        `;
                }).join('');
                }

                async function handleSaveName() {
                const newName = newNameInput.value.trim();
                if (newName.length < 3 || newName.length > 15) {
                        saveNameFeedback.textContent = 'Name must be 3-15 characters.';
                        saveNameFeedback.classList.remove('text-green-400');
                        saveNameFeedback.classList.add('text-red-400');
                        return;
                }
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                await setDoc(publicProfileRef, { displayName: newName }, { merge: true });
               
                saveNameFeedback.classList.remove('text-red-400');
                saveNameFeedback.classList.add('text-green-400');
                saveNameFeedback.textContent = 'Name updated successfully!';

                newNameInput.disabled = true;
                saveNameBtn.classList.add('hidden');
                editNameBtn.classList.remove('hidden');

                setTimeout(() => {
                        saveNameFeedback.textContent = '';
                }, 2000);
                }

                function getTodayDateString() {
                const today = new Date();
                return today.toISOString().split('T')[0];
                }

                async function checkAndUpdateStreak() {
                if (!userId) return;
                const streakRef = doc(db, `artifacts/${appId}/users/${userId}/streak/data`);
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                const docSnap = await getDoc(streakRef);
                let streakData = { current: 0, lastActive: null };

                if (docSnap.exists()) {
                        streakData = docSnap.data();
                        const today = getTodayDateString();
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayString = yesterday.toISOString().split('T')[0];

                        if (streakData.lastActive !== today && streakData.lastActive !== yesterdayString) {
                        streakData.current = 0;
                        await setDoc(publicProfileRef, { streak: 0 }, { merge: true });
                        }
                }
                streakCountEl.textContent = streakData.current;
                await setDoc(streakRef, streakData, { merge: true });
                }

                async function markDayAsCompleted() {
                if (!userId) return;
                const streakRef = doc(db, `artifacts/${appId}/users/${userId}/streak/data`);
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
               
                const [streakSnap, publicSnap] = await Promise.all([getDoc(streakRef), getDoc(publicProfileRef)]);
               
                const today = getTodayDateString();
                let streakData = { current: 0, lastActive: null };
                if (streakSnap.exists()) {
                        streakData = streakSnap.data();
                }

                if (streakData.lastActive !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayString = yesterday.toISOString().split('T')[0];

                        if (streakData.lastActive === yesterdayString) {
                        streakData.current += 1;
                        } else {
                        streakData.current = 1;
                        }
                        streakData.lastActive = today;

                        const userBadges = publicSnap.exists() ? publicSnap.data().badges || [] : [];
                        const newBadges = [];
                        for (const badgeId in BADGES) {
                        if (streakData.current >= BADGES[badgeId].streak && !userBadges.includes(badgeId)) {
                                newBadges.push(badgeId);
                        }
                        }
                       
                        const batch = writeBatch(db);
                        batch.set(streakRef, streakData);
                        const publicUpdate = { streak: streakData.current };
                        if (newBadges.length > 0) {
                        publicUpdate.badges = arrayUnion(...newBadges);
                        }
                        batch.update(publicProfileRef, publicUpdate);
                        await batch.commit();

                        streakCountEl.textContent = streakData.current;

                        newBadges.forEach(badgeId => {
                        showBadgeUnlockedModal(BADGES[badgeId]);
                        });
                }
                }
               
                function showBadgeUnlockedModal(badge) {
                const modalHTML = `
                        <div id="badge-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center">
                                <h2 class="text-2xl font-bold mb-2 text-yellow-400">Badge Unlocked!</h2>
                                <div class="w-24 h-24 mx-auto my-4 text-yellow-400">${badge.svg.replace('w-10 h-10', 'w-24 h-24')}</div>
                                <p class="text-lg font-semibold">${badge.name}</p>
                                <button id="close-badge-modal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition">Awesome!</button>
                        </div>
                        </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.getElementById('close-badge-modal').onclick = () => {
                        document.getElementById('badge-modal-overlay').remove();
                };
                }

                // --- Leaderboard Logic ---
                async function showLeaderboardScreen() {
                showScreen(leaderboardView);
                showLoading('leaderboard');
                leaderboardSearch.value = '';

                try {
                        // Fetch all real users for the leaderboard
                        const usersCollectionPath = `artifacts/${appId}/public/data/users`;
                        const q = query(collection(db, usersCollectionPath));
                        const querySnapshot = await getDocs(q);
                        allUsers = [];
                        querySnapshot.forEach((doc) => {
                        allUsers.push(doc.data());
                        });

                        renderLeaderboard(allUsers);

                } catch (error) {
                        console.error("Error fetching leaderboard:", error);
                        displayError('leaderboard');
                }
                }

                function renderLeaderboard(usersToRender) {
                usersToRender.sort((a, b) => (b.streak || 0) - (a.streak || 0));

                if (usersToRender.length === 0) {
                        leaderboardList.innerHTML = `<p class="text-center text-gray-400 p-4">No users found.</p>`;
                        return;
                }

                leaderboardList.innerHTML = usersToRender.map((user, index) => {
                        const isCurrentUser = user.userId === userId;
                        return `
                        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
                                <div class="w-8 text-center text-lg font-bold text-gray-400">${index + 1}</div>
                                <div class="flex-1">
                                <h3 class="font-bold text-white">${user.displayName} ${isCurrentUser ? '(You)' : ''}</h3>
                                </div>
                                <div class="flex items-center gap-2 text-orange-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z"></path></svg>
                                <span class="font-bold text-lg">${user.streak || 0}</span>
                                </div>
                        </div>`;
                }).join('');
                }

                function handleSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredUsers = allUsers.filter(user => user.displayName.toLowerCase().includes(searchTerm));
                renderLeaderboard(filteredUsers);
                }

                // --- Quiz Logic ---
                async function handleJoinRoom(e) {
                e.preventDefault();
                const roomCode = document.getElementById('room-code-input').value.trim();
                if (!roomCode) return;

                const roomRef = doc(db, `artifacts/${appId}/public/data/quizRooms`, roomCode);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                        const roomData = roomSnap.data();
                        quizData = roomData.quizData;
                        userQuizAnswers = {};
                        quizStartView.classList.add('hidden');
                        quizContentWrapper.classList.remove('hidden');
                        quizConfigView.classList.add('hidden');
                        renderQuizUI();
                } else {
                        alert("Room not found!");
                }
                }

                function showQuizConfigScreen(points) {
                if (!Array.isArray(points) || points.length === 0) {
                        console.error("Invalid points data for quiz:", points);
                        showScreen(quizView);
                        quizContentWrapper.classList.add('hidden');
                        quizPlaceholder.classList.remove('hidden');
                        quizPlaceholder.textContent = 'Not enough data to generate a quiz for this session.';
                        return;
                }
                quizPoints = points;
                showScreen(quizView);
                quizPlaceholder.classList.add('hidden');
                quizContentWrapper.classList.remove('hidden');
                quizStartView.classList.add('hidden');
                quizConfigView.classList.remove('hidden');
                quizActiveViewWrapper.classList.add('hidden');
                }

                async function handleQuizTopicSubmit(e) {
                e.preventDefault();
                const topic = document.getElementById('quiz-topic-input').value.trim();
                if (!topic) return;

                showLoading('quiz');
                try {
                        const points = await fetchFlashcardsFromAI(topic, 15);
                        showQuizConfigScreen(points.map(p => p.point));
                } catch (error) {
                        console.error("Error generating quiz points from topic:", error);
                        displayError('quiz');
                }
                }

                async function handleQuizFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;

                const feedbackEl = document.getElementById('quiz-upload-feedback');
                feedbackEl.innerHTML = `<div class="spinner mx-auto mt-4" style="width: 24px; height: 24px; border-width: 2px;"></div>`;

                try {
                        const text = await extractTextFromPdf(file);
                        const topic = await getTopicFromDocument(text);
                        const points = await fetchFlashcardsFromAI(topic, 15, 1, [], text);
                        showQuizConfigScreen(points.map(p => p.point));
                } catch (error) {
                        console.error("Error generating quiz points from file:", error);
                        feedbackEl.innerHTML = `<p class="text-red-400 mt-2">Could not process file.</p>`;
                }
                }

                async function handleBeginQuiz() {
                const isTimeMode = quizModeToggle.checked;
                let questionCount = null;
                let timeLimit = null;

                if (isTimeMode) {
                        const selectedTimeBtn = quizTimeMode.querySelector('.time-btn.selected');
                        if (!selectedTimeBtn) {
                        const timeModeLabel = quizTimeMode.querySelector('label');
                        timeModeLabel.textContent = 'Please select a duration!';
                        timeModeLabel.classList.add('text-red-400');
                        return;
                        }
                        timeLimit = parseInt(selectedTimeBtn.dataset.time, 10);
                } else {
                        questionCount = document.getElementById('quiz-question-count').value;
                }
               
                quizConfigView.classList.add('hidden');
                quizActiveViewWrapper.classList.remove('hidden');
                quizActiveView.innerHTML = `<div class="flex flex-col items-center justify-center p-8 h-full"><div class="spinner"></div><p class="mt-4 text-gray-400">Generating questions...</p></div>`;

                try {
                        quizData = await fetchQuizFromAI(quizPoints, questionCount, timeLimit);
                        userQuizAnswers = {};
                       
                        const roomCode = (Math.random() + 1).toString(36).substring(2, 8).toUpperCase();
                        const roomRef = doc(db, `artifacts/${appId}/public/data/quizRooms`, roomCode);
                        await setDoc(roomRef, { quizData: quizData, createdAt: serverTimestamp() });

                        renderQuizUI();
                        if (isTimeMode) {
                        startQuizTimer(timeLimit);
                        }
                       
                        const roomCodeEl = document.getElementById('quiz-room-code');
                        roomCodeEl.innerHTML = `Room: <span class="text-green-400">${roomCode}</span>`;

                } catch (error) {
                        console.error("Error starting quiz:", error);
                        displayError('quiz');
                }
                }

                function startQuizTimer(minutes) {
                let seconds = minutes * 60;
                quizTimerEl.classList.remove('hidden');

                quizTimerInterval = setInterval(() => {
                        seconds--;
                        const min = Math.floor(seconds / 60);
                        const sec = seconds % 60;
                        quizTimerEl.textContent = `Time Left: ${min}:${sec < 10 ? '0' : ''}${sec}`;

                        if (seconds <= 0) {
                        clearInterval(quizTimerInterval);
                        quizTimerEl.textContent = "Time's up!";
                        handleSubmitQuiz(true); // Auto-submit
                        }
                }, 1000);
                }

                function renderQuizUI() {
                quizConfigView.classList.add('hidden');
                quizActiveViewWrapper.classList.remove('hidden');
               
                let quizHTML = '';
                quizData.forEach((q, index) => {
                        quizHTML += `<div class="quiz-question-slide">
                        <div class="quiz-question-card">
                                <p class="text-gray-400 mb-2">Question ${index + 1} of ${quizData.length}</p>
                                <h3 class="text-xl font-bold mb-6">${q.question}</h3>
                                ${q.type === 'mcq' ? renderMCQOptions(q.options, index) : renderShortAnswer(index)}
                        </div>
                        </div>`;
                });
               
                quizHTML += `<div class="quiz-question-slide">
                        <div class="quiz-question-card text-center">
                        <h3 class="text-2xl font-bold text-purple-400">Ready to submit?</h3>
                        <p class="text-gray-400 my-4">Scroll up to review your answers.</p>
                        <button id="submit-quiz-btn" class="w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Finish Quiz</button>
                        </div>
                </div>`;

                quizActiveView.innerHTML = quizHTML;
                attachQuizAnswerListeners();
                }

                function renderMCQOptions(options, questionIndex) {
                return `<div class="space-y-3">${options.map(option => `
                        <button class="quiz-option w-full text-left bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition" data-q-index="${questionIndex}" data-option="${option}">
                        ${option}
                        </button>
                `).join('')}</div>`;
                }

                function renderShortAnswer(questionIndex) {
                return `<textarea class="quiz-short-answer w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Type your answer here..." data-q-index="${questionIndex}"></textarea>`;
                }
               
                function attachQuizAnswerListeners() {
                quizActiveView.querySelectorAll('.quiz-option').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                        const qIndex = e.currentTarget.dataset.qIndex;
                        const option = e.currentTarget.dataset.option;
                        userQuizAnswers[qIndex] = option;
                       
                        const parent = e.currentTarget.parentElement;
                        parent.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected-option'));
                        e.currentTarget.classList.add('selected-option');
                        });
                });

                quizActiveView.querySelectorAll('.quiz-short-answer').forEach(textarea => {
                        textarea.addEventListener('input', (e) => {
                        const qIndex = e.currentTarget.dataset.qIndex;
                        userQuizAnswers[qIndex] = e.currentTarget.value;
                        });
                });

                document.getElementById('submit-quiz-btn').onclick = () => handleSubmitQuiz(false);
                }

                async function handleSubmitQuiz(isAutoSubmit = false) {
                if (quizTimerInterval) {
                        clearInterval(quizTimerInterval);
                        quizTimerInterval = null;
                }
               
                showScreen(quizBreakdownView);
                quizBreakdownContent.innerHTML = `<div class="flex flex-col items-center justify-center p-8 h-full"><div class="spinner"></div><p id="results-loading-text" class="mt-4 text-gray-400">Calculating results...</p></div>`;
                const resultsLoadingText = document.getElementById('results-loading-text');

                let mcqScore = 0;
                const allWrongQuestions = [];
                const shortAnswersToGrade = [];

                quizData.forEach((q, index) => {
                        const userAnswer = userQuizAnswers[index]?.trim();
                        if (q.type === 'mcq') {
                        if (userAnswer && userAnswer.toLowerCase() === q.answer.trim().toLowerCase()) {
                                mcqScore++;
                        } else {
                                allWrongQuestions.push({ question: q.question, correctAnswer: q.answer, yourAnswer: userAnswer || "No answer" });
                        }
                        } else if (q.type === 'short_answer' && userAnswer) {
                        shortAnswersToGrade.push({ question: q.question, correctAnswer: q.answer, userAnswer: userAnswer });
                        }
                });

                let shortAnswerScore = 0;
                if (shortAnswersToGrade.length > 0) {
                        try {
                        resultsLoadingText.textContent = 'Evaluating short answers...';
                        const gradedAnswers = await fetchShortAnswerScoresFromAI(shortAnswersToGrade);
                        gradedAnswers.forEach(graded => {
                                if (graded.isCorrect) {
                                shortAnswerScore++;
                                } else {
                                const originalQuestion = shortAnswersToGrade.find(sa => sa.question === graded.question);
                                if (originalQuestion) {
                                        allWrongQuestions.push({
                                        question: originalQuestion.question,
                                        correctAnswer: originalQuestion.correctAnswer,
                                        yourAnswer: originalQuestion.userAnswer
                                        });
                                }
                                }
                        });
                        } catch (e) {
                        console.error("Failed to grade short answers:", e);
                        }
                }
               
                const totalScore = mcqScore + shortAnswerScore;
               
                let analysis = { summary: "You did great! Keep up the good work.", breakdown: [] };
                if (allWrongQuestions.length > 0) {
                        try {
                        resultsLoadingText.textContent = 'Generating feedback...';
                        analysis = await fetchQuizAnalysisFromAI(allWrongQuestions);
                        } catch (e) {
                        console.error("Failed to get weakness summary:", e);
                        analysis.summary = "Could not generate a summary, but review the questions you got wrong to improve!";
                        }
                }

                renderQuizBreakdown(totalScore, quizData.length, analysis.summary, analysis.breakdown, isAutoSubmit);
                }

                function renderQuizBreakdown(score, total, summary, breakdown, isAutoSubmit) {
                quizBreakdownContent.innerHTML = `
                        <div class="text-center">
                        <h3 class="text-2xl font-bold text-purple-400">Quiz Complete!</h3>
                        ${isAutoSubmit ? '<p class="text-yellow-400 font-semibold">Time ran out!</p>' : ''}
                        <p class="text-lg text-gray-300 mt-2">Your Score:</p>
                        <p class="text-5xl font-bold my-4">${score} / ${total}</p>
                        </div>
                        <div class="mt-6">
                        <h4 class="text-xl font-bold text-gray-100">Focus Area</h4>
                        <p class="bg-gray-700/50 p-4 rounded-lg mt-2 text-gray-300">${summary}</p>
                        </div>
                        <div id="wrong-answers-container" class="mt-6 space-y-4">
                        <h4 class="text-xl font-bold text-gray-100">Review Your Answers</h4>
                        ${breakdown.map(item => `
                                <div class="bg-gray-700/50 p-4 rounded-lg">
                                <p class="font-semibold">${item.question}</p>
                                <p class="text-sm text-red-400 mt-2">Your Answer: ${item.yourAnswer}</p>
                                <p class="text-sm text-green-400 mt-1">Correct Answer: ${item.correctAnswer}</p>
                                <p class="text-sm text-gray-400 mt-2"><span class="font-semibold">Explanation:</span> ${item.explanation}</p>
                                </div>
                        `).join('')}
                        </div>
                        <div class="mt-8">
                        <button id="quiz-retake-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">Retake Quiz</button>
                        <button id="quiz-done-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition mt-3">Finish</button>
                        </div>
                `;
                document.getElementById('quiz-done-btn').onclick = goHome;
                document.getElementById('quiz-retake-btn').onclick = () => showQuizConfigScreen(quizPoints);
                }

                // --- PDF Processing ---
                async function extractTextFromPdf(file) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                        reader.onload = async (event) => {
                        try {
                                const pdf = await pdfjsLib.getDocument(event.target.result).promise;
                                let allText = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                allText += textContent.items.map(item => item.str).join(' ') + '\n';
                                }
                                resolve(allText);
                        } catch (error) {
                                reject(error);
                        }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                });
                }


                // --- AI API Calls ---
                async function getTopicFromDocument(text) {
                const prompt = `Analyze the following text and determine its main topic. Respond with ONLY the main topic as a short phrase. Text: "${text.substring(0, 2000)}"`;
                return await callGemini(prompt);
                }

                async function shortenTopicName(topic) {
                if (topic.length <= 25) return topic;
                try {
                        const prompt = `Your task is to shorten a topic title for a mobile app header. Respond with ONLY the shortened title. It should be a very short, concise, and meaningful phrase that fits on a single line. Do not add any other text, explanation, or punctuation. The topic is: "${topic}"`;
                        const shortName = await callGemini(prompt);
                        return shortName.replace(/["'.]/g, '').trim();
                } catch (error) {
                        console.error("Could not shorten topic name, using original:", error);
                        return topic;
                }
                }

                async function fetchFlashcardsFromAI(topic, cardCount, level, seenPoints, docText = '') {
                let prompt;
                if (docText && level === 1) {
                        prompt = `Summarize the key points from the following document into a list of ${cardCount} flashcards. Each point should be a short, self-contained piece of information. Document text: "${docText.substring(0, 4000)}"`;
                } else if (docText && level > 1) {
                        prompt = `The user has learned the key points from a document about "${topic}". Now, generate ${cardCount} new, more advanced flashcards on the same topic that introduce information NOT found in the original document. Original document text for context: "${docText.substring(0, 2000)}"`;
                } else {
                        prompt = `Based on the topic "${topic}", generate a list of ${cardCount} distinct key points.`;
                        if (level > 1) prompt += ` These points should be more advanced and detailed.`;
                        else prompt += ` The points should be suitable for a beginner.`;
                }

                if (seenPoints && seenPoints.length > 0) {
                        prompt += ` IMPORTANT: Do NOT repeat any of the following points the user has already seen: ${JSON.stringify(seenPoints)}.`;
                }
                prompt += ` Return the response as a valid JSON array of objects. Each object must have a single key "point" with the text as its value.`;
                const resultText = await callGemini(prompt);
                return parseJsonFromAiResponse(resultText, 'array');
                }
               
                async function fetchReviewSummaryFromAI(itemsToReview) {
                const pointsToReview = JSON.stringify(itemsToReview.map(item => item.point));
                const prompt = `A student needs help understanding key points. For each point, provide a clear explanation. Return a valid JSON array of objects. Each object must have two keys: "point" (the original point) and "explanation" (a simple explanation). Points to review: ${pointsToReview}`;
                const resultText = await callGemini(prompt);
                return parseJsonFromAiResponse(resultText, 'array');
                }

                async function fetchQuizFromAI(points, questionCount, timeLimit = null) {
                const pointsToQuiz = JSON.stringify(points.slice(0, 20));
                let prompt = `Based on the following key points, generate a quiz. `;

                if (timeLimit) {
                        prompt += `The user has selected a ${timeLimit}-minute time limit. Generate an appropriate number of questions (a mix of mcq and short_answer) that can be reasonably answered in this time. A shorter time means fewer/simpler questions, a longer time allows for more/complex ones. `;
                } else {
                        prompt += `Generate exactly ${questionCount} questions. The questions should be a mix of multiple-choice and short-answer types. `;
                }

                prompt += `Return a valid JSON array of objects. Each object must have these keys: "type" (string: "mcq" or "short_answer"), "question" (string), "options" (an array of 4 strings, empty [] for "short_answer"), and "answer" (a string that matches an option for mcq, or the correct short answer). Key points for context: ${pointsToQuiz}`;
                const resultText = await callGemini(prompt);
                return parseJsonFromAiResponse(resultText, 'array');
                }

                async function fetchShortAnswerScoresFromAI(answers) {
                const prompt = `A student took a quiz. For each of the following short-answer questions, evaluate if the student's answer is correct. The student's answer doesn't need to be an exact match, but it should capture the main idea of the correct answer. The questions and answers are: ${JSON.stringify(answers)}. Return a valid JSON array of objects. Each object must have two keys: "question" (the original question text) and "isCorrect" (a boolean: true if the user's answer is correct or mostly correct, otherwise false).`;
                const resultText = await callGemini(prompt);
                return parseJsonFromAiResponse(resultText, 'array');
                }

                async function fetchQuizAnalysisFromAI(wrongQuestions) {
                const prompt = `A student took a quiz and got the following questions wrong: ${JSON.stringify(wrongQuestions)}. For each question, provide a brief explanation for why the correct answer is right. Also, provide a short, encouraging overall summary (2-3 sentences) of what they should focus on. Respond with a single valid JSON object with two keys: "summary" (string) and "breakdown" (an array of objects, where each object has "question", "correctAnswer", "yourAnswer", and "explanation" keys).`;
                const resultText = await callGemini(prompt);
                return parseJsonFromAiResponse(resultText, 'object');
                }

                function parseJsonFromAiResponse(text, expectedType = 'array') {
                try {
                        const match = expectedType === 'array' ? text.match(/(\[[\s\S]*\])/) : text.match(/(\{[\s\S]*\})/);
                        if (match && match[0]) {
                        return JSON.parse(match[0]);
                        } else {
                        throw new Error(`Could not extract JSON ${expectedType} from AI response.`);
                        }
                } catch (e) {
                        console.error(`Failed to parse JSON from AI response:`, text);
                        throw new Error("Invalid JSON response from AI.");
                }
                }

                async function callGemini(prompt) {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyCpFp6NvQD6HSdbZALnbYQslHgmURONrFY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const result = await response.json();
               
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                } else {
                        console.error("Unexpected API response:", result);
                        throw new Error("Failed to parse AI response.");
                }
                }
        </script>
        </body>
        </html>
